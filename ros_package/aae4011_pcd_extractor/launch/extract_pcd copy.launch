<?xml version="1.0"?>
<launch>
  <!-- Argument: Path to the rosbag file to play -->
  <!-- No default - must be provided by user (will error if not specified) -->
  <arg name="bag_file" />
  <!-- Argument: Point cloud topic name -->
  <!-- Default: /velodyne_points (common LiDAR topic name) -->
  <arg name="topic" default="/points_raw" />
  
  <!-- Argument: Output directory for PCD files -->
  <!-- Default: /tmp/pcd_output (temporary directory, safe for testing) -->
  <arg name="output_dir" default="/tmp/pcd_output" />
  
  <!-- Argument: Playback rate for rosbag (1.0 = real-time) -->
  <!-- Can slow down (0.5 = half speed) or speed up (2.0 = double speed) -->
  <arg name="rate" default="1.0" />
  
  <!-- Argument: Start paused? (true/false) -->
  <!-- If true, bag starts paused and user must press space to play -->
  <arg name="start_paused" default="false" />
  
  <!-- 
    ==========================================================================
    INFORMATION MESSAGES (Optional but helpful)
    ==========================================================================
    
    Display information to the user when launch file starts.
    This helps users understand what's happening and verify configuration.
  -->
  
  <arg name="info_header" value="
  ========================================
  PCD Extractor Launch File
  ========================================" />
  
  <!-- Print header (trick: use arg with value to print) -->
  <param name="info_header" value="$(arg info_header)" />
  
  <!-- 
    ==========================================================================
    NODE: PCD Extractor
    ==========================================================================
    
    <node> tag starts a ROS node.
    
    Attributes explained:
    - pkg: Package name (must match package.xml)
    - type: Executable name (from add_executable in CMakeLists.txt)
    - name: Name for this node instance in ROS graph
      * Can be different from executable name
      * Must be unique if running multiple instances
      * Used in rostopic list, rosnode list
    - output: Where to print node's stdout/stderr
      * "screen": Print to terminal (see ROS_INFO messages)
      * "log": Write to log files only (~/.ros/log/)
    - required: If "true", shutdown all nodes if this one dies
    - respawn: If "true", restart node if it crashes
    - respawn_delay: Seconds to wait before respawning
    - launch-prefix: Prefix command (e.g., "gdb -ex run --args" for debugging)
    
    Best practices:
    - Set output="screen" for debugging
    - Use respawn="true" for critical nodes in production
    - Give descriptive names that indicate purpose
  -->
  
  <node 
    pkg="aae4011_pcd_extractor" 
    type="pcd_extractor_node" 
    name="pcd_extractor_node" 
    output="screen"
  >
    <!-- 
      ========================================================================
      NODE PARAMETERS
      ========================================================================
      
      <param> tags set parameters in this node's private namespace.
      Parameters are loaded before the node starts.
      
      Private namespace: /node_name/param_name
      Example: /pcd_extractor_node/output_directory
      
      In the C++ code, we access these with:
      nh_.param<std::string>("output_directory", output_dir_, "default");
      
      Types supported: string, int, double, bool, yaml
    -->
    
    <!-- Output directory parameter -->
    <!-- Uses the launch file argument, allowing easy override -->
    <param name="output_directory" value="$(arg output_dir)" />
    
    <!-- Point cloud topic to subscribe to -->
    <!-- Uses the launch file argument -->
    <param name="pointcloud_topic" value="$(arg topic)" />
    
    <!-- 
      ========================================================================
      TOPIC REMAPPING (Alternative method)
      ========================================================================
      
      Instead of passing topic as a parameter, we could remap it:
      <remap from="/original_topic" to="$(arg topic)" />
      
      Remapping changes topic names without modifying code.
      Useful when integrating with other packages that publish to different names.
      
      Example: If our code subscribes to "/velodyne_points", but the bag
      has "/kitti/velo/pointcloud", we can remap:
      <remap from="/velodyne_points" to="/kitti/velo/pointcloud" />
    -->
    
  </node>
  
  <!-- 
    ==========================================================================
    NODE: Rosbag Player
    ==========================================================================
    
    The "play" node is a ROS built-in node (part of rosbag package).
    It reads a bag file and republishes messages to topics.
    
    Attributes:
    - pkg="rosbag": The rosbag tools package
    - type="play": The play executable
    - name="player": Name in ROS graph
    - args: Command-line arguments for rosbag play
    
    Common rosbag play arguments:
    - filename: Path to bag file (required)
    - -r RATE: Playback rate multiplier (1.0 = real-time)
    - -d SEC: Delay SEC seconds before starting
    - -s SEC: Start SEC seconds into bag
    - -u SEC: Play only SEC seconds
    - --clock: Publish /clock topic (for simulation time)
    - --pause: Start in paused state
    - --loop: Loop playback
    - --topics: Only play specific topics
    - --wait-for-subscribers: Wait for subscribers before publishing
    
    The $(arg name) syntax substitutes launch file arguments.
  -->
  
  <node 
    pkg="rosbag" 
    type="play" 
    name="player" 
    output="screen"
    args="--clock -r $(arg rate) $(arg bag_file)"
    if="$(eval not start_paused)"
  >
    <!-- 
      Note: We use "if" attribute to conditionally start based on start_paused arg
      If you want to always start paused, add --pause to args
    -->
  </node>
  
  <!-- Alternative: Start paused version -->
  <node 
    pkg="rosbag" 
    type="play" 
    name="player" 
    output="screen"
    args="--clock --pause -r $(arg rate) $(arg bag_file)"
    if="$(arg start_paused)"
  >
    <!-- User must press space in terminal to start playback -->
  </node>
  
  <!-- 
    ==========================================================================
    OPTIONAL: RViz Visualization (Commented out)
    ==========================================================================
    
    Uncomment this section to automatically open RViz for visualization.
    RViz is ROS's 3D visualization tool.
  -->
  
  <!--
  <node 
    pkg="rviz" 
    type="rviz" 
    name="rviz" 
    output="screen"
    args="-d $(find aae4011_pcd_extractor)/rviz/pcd_extractor.rviz"
  />
  -->
  
  <!-- 
    To use RViz:
    1. Create an rviz config file with appropriate settings
    2. Save it to: aae4011_pcd_extractor/rviz/pcd_extractor.rviz
    3. Uncomment the node above
    4. In RViz, add PointCloud2 display subscribing to your topic
  -->
  
  <!-- 
    ==========================================================================
    OPTIONAL: Parameter File (Commented out)
    ==========================================================================
    
    For many parameters, use rosparam to load from a YAML file.
  -->
  
  <!--
  <rosparam command="load" file="$(find aae4011_pcd_extractor)/config/params.yaml" />
  -->
  
  <!-- 
    Example params.yaml:
    
    pcd_extractor_node:
      output_directory: "/tmp/pcd_output"
      pointcloud_topic: "/velodyne_points"
      save_every_n: 1
      enable_filtering: false
  -->
  
  <!-- 
    ==========================================================================
    OPTIONAL: Include Other Launch Files (Commented out)
    ==========================================================================
    
    You can include other launch files to build complex systems.
  -->
  
  <!--
  <include file="$(find other_package)/launch/other_launch.launch">
    <arg name="param1" value="value1" />
  </include>
  -->
  
  <!-- 
    ==========================================================================
    OPTIONAL: Groups and Namespaces (Commented out)
    ==========================================================================
    
    Groups allow you to apply settings to multiple nodes.
    Namespaces prevent topic name collisions.
  -->
  
  <!--
  <group ns="robot1">
    <node pkg="..." type="..." name="..." />
    <node pkg="..." type="..." name="..." />
  </group>
  
  <group ns="robot2">
    <node pkg="..." type="..." name="..." />
    <node pkg="..." type="..." name="..." />
  </group>
  -->
  
  <!-- 
    ==========================================================================
    OPTIONAL: Machine Tags (Commented out)
    ==========================================================================
    
    Run nodes on remote machines via SSH.
  -->
  
  <!--
  <machine name="robot_pc" address="192.168.1.100" user="ubuntu" />
  
  <node pkg="..." type="..." name="..." machine="robot_pc" />
  -->
  
  <!-- 
    ==========================================================================
    OPTIONAL: Environment Variables (Commented out)
    ==========================================================================
    
    Set environment variables for all nodes in this launch file.
  -->
  
  <!--
  <env name="SOME_VARIABLE" value="some_value" />
  -->
  
  <!-- 
    ==========================================================================
    SUMMARY FOR STUDENTS
    ==========================================================================
    
    WHAT THIS LAUNCH FILE DOES:
    
    1. Accepts arguments: bag_file, topic, output_dir, rate, start_paused
    2. Starts the pcd_extractor_node with configured parameters
    3. Starts rosbag player to publish messages from bag file
    4. All stdout/stderr prints to terminal (output="screen")
    5. Uses /clock from bag for synchronized timing
    
    USAGE EXAMPLES:
    
    Basic (with defaults):
    $ roslaunch aae4011_pcd_extractor extract_pcd.launch \
        bag_file:=/path/to/data.bag
    
    Custom topic and output:
    $ roslaunch aae4011_pcd_extractor extract_pcd.launch \
        bag_file:=/path/to/data.bag \
        topic:=/my_lidar/points \
        output_dir:=/home/user/pcd_files
    
    Slow motion playback:
    $ roslaunch aae4011_pcd_extractor extract_pcd.launch \
        bag_file:=/path/to/data.bag \
        rate:=0.5
    
    Start paused (good for debugging):
    $ roslaunch aae4011_pcd_extractor extract_pcd.launch \
        bag_file:=/path/to/data.bag \
        start_paused:=true
    
    HOW TO MODIFY FOR YOUR NEEDS:
    
    1. Add more arguments:
       <arg name="my_arg" default="value" />
    
    2. Add more nodes:
       <node pkg="..." type="..." name="..." />
    
    3. Add more parameters:
       <param name="param_name" value="param_value" />
    
    4. Remap topics:
       <remap from="old_topic" to="new_topic" />
    
    5. Conditional execution:
       <node ... if="$(arg condition)" />
       <node ... unless="$(arg condition)" />
    
    DEBUGGING TIPS:
    
    # Check what's running:
    $ rosnode list
    
    # Check topics:
    $ rostopic list
    $ rostopic echo /velodyne_points
    
    # Check parameters:
    $ rosparam list
    $ rosparam get /pcd_extractor_node/output_directory
    
    # Kill specific node:
    $ rosnode kill /pcd_extractor_node
    
    # Restart just one node (if respawn="false"):
    $ rosrun aae4011_pcd_extractor pcd_extractor_node
    
    COMMON MISTAKES:
    
    ✗ Forgetting to provide required arguments (bag_file)
    ✗ Wrong package or node name (typos)
    ✗ File paths with spaces (use quotes in command line)
    ✗ Conflicting node names (each node name must be unique)
    ✗ Wrong topic names (check with rosbag info)
    
    EXERCISES:
    
    1. Add argument for saving only every Nth cloud
    2. Add conditional launch of RViz
    3. Create separate launch files for different sensors
    4. Add rqt_graph to visualize node connections
    5. Add multiple pcd_extractor nodes with different topics
    6. Create a "master" launch file that includes this one
    
    ==========================================================================
  -->
  
</launch>
